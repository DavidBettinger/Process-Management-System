<section class="hold-form">
  <header class="hold-header">
    <div>
      <h2>Termin durchfuehren</h2>
      <p>Halte Protokoll fest und lege Aufgabenpunkte an.</p>
    </div>
  </header>

  @if (holdResult) {
    <div class="result">
      <p class="result-title">Termin abgeschlossen</p>
      <p class="result-text">Erstellte Aufgaben: {{ holdResult.createdTaskIds.length }}</p>
      <p class="result-hint">Die Aufgaben findest du in der Aufgabenliste dieses Prozesses.</p>
      <button class="ghost-button" type="button" (click)="clearHoldResult()">
        Hinweis schliessen
      </button>
    </div>
  }

  <form class="form" [formGroup]="form" (ngSubmit)="submit()">
    @if (meetings.length > 0) {
      <label>
        Termin
        <select formControlName="meetingId" (change)="applyMeetingDefaults(form.controls.meetingId.value)">
          <option value="">Bitte waehlen</option>
          @for (meeting of meetings; track meeting.id) {
            <option [value]="meeting.id">{{ meetingLabel(meeting) }}</option>
          }
        </select>
        @if (isInvalid('meetingId')) {
          <span class="error">{{ requiredMessage('Termin') }}</span>
        }
      </label>
    } @else {
      <label>
        Termin
        <input type="text" formControlName="meetingId" placeholder="Termin eingeben" />
      </label>
      @if (isInvalid('meetingId')) {
        <span class="error">{{ requiredMessage('Termin') }}</span>
      }
      <p class="hint">Kein Termin vorhanden? Bitte zuerst einen Termin planen.</p>
    }

    <label>
      Durchgefuehrt am
      <input type="datetime-local" formControlName="heldAt" />
    </label>
    @if (isInvalid('heldAt')) {
      <span class="error">{{ requiredMessage('Durchgefuehrt am') }}</span>
    }

    <label>
      Standort
      <select formControlName="locationId">
        <option value="">Bitte waehlen</option>
        @for (location of locations; track location.id) {
          <option [value]="location.id">
            {{ location.label }} Â· {{ location.address.city }}
          </option>
        }
      </select>
    </label>
    @if (isInvalid('locationId')) {
      <span class="error">{{ requiredMessage('Standort') }}</span>
    }
    @if (locations.length === 0) {
      <p class="hint">Es sind noch keine Standorte vorhanden. Bitte zuerst einen Standort anlegen.</p>
    }
    <a class="link" routerLink="/locations">Neuen Standort anlegen</a>

    <div class="participants">
      <div class="participants-header">
        <p>Teilnehmende</p>
        <button class="ghost-button" type="button" (click)="addParticipant()">Teilnehmende hinzufuegen</button>
      </div>
      @for (participantId of participantIds; track $index; let i = $index) {
        <div class="participant-row">
          <app-stakeholder-select
            [stakeholders]="stakeholders"
            [selectedId]="participantId || null"
            [disabled]="!stakeholdersReady"
            [required]="true"
            (selectedIdChange)="updateParticipant(i, $event)"
          />
          <button
            class="ghost-button"
            type="button"
            (click)="removeParticipant(i)"
            [disabled]="participantIds.length === 1"
          >
            Entfernen
          </button>
        </div>
      }
      @if (participantsError) {
        <p class="error">{{ participantsError }}</p>
      }
      @if (!stakeholdersReady && !stakeholdersError) {
        <div class="state">
          <p class="state-title">Beteiligte werden geladen</p>
        </div>
      }
      @if (!stakeholdersReady && stakeholdersError) {
        <div class="state">
          <p class="state-title">Beteiligte konnten nicht geladen werden</p>
          <p class="state-text">{{ stakeholdersError }}</p>
        </div>
      }
    </div>

    <label>
      Protokoll
      <textarea formControlName="minutesText" rows="4" placeholder="Wichtige Ergebnisse und Beschluesse"></textarea>
    </label>
    @if (isInvalid('minutesText')) {
      <span class="error">{{ requiredMessage('Protokoll') }}</span>
    }

    <app-action-items-editor
      [items]="actionItems"
      [stakeholders]="stakeholders"
      (itemsChange)="updateActionItems($event)"
    />

    @if (actionItemsError) {
      <p class="error">{{ actionItemsError }}</p>
    }

    <button class="primary-button" type="submit" [disabled]="isLoading || !stakeholdersReady">
      Termin abschliessen
    </button>
  </form>
</section>
