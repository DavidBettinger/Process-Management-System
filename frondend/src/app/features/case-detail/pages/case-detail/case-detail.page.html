<section class="page">
  <header class="page-header">
    <div>
      <p class="eyebrow">Prozess</p>
      <h1>Prozessdetails</h1>
      <p class="subtitle">Status, Beteiligte und naechste Schritte im Blick behalten.</p>
    </div>
    <div class="actions">
      <button
        class="primary-button"
        type="button"
        [disabled]="!canActivate() || isLoading()"
        (click)="activateCase()">
        Prozess aktivieren
      </button>
      @if (activationHint()) {
        <p class="hint">{{ activationHint() }}</p>
      }
    </div>
  </header>

  <div class="content-grid">
    <div class="panel">
      @if (isLoading()) {
        <div class="state">
          <div class="skeleton"></div>
          <div class="skeleton"></div>
        </div>
      }

      @if (status() === 'error') {
        <div class="state">
          <p class="state-title">Prozess konnte nicht geladen werden</p>
          <p class="state-text">{{ error()?.message ?? 'Unbekannter Fehler' }}</p>
          <button class="ghost-button" type="button" (click)="caseStore.loadCase()">
            Erneut versuchen
          </button>
        </div>
      }

      @if (status() === 'success') {
        @if (caseData(); as data) {
          <div class="details">
            <div class="meta">
              <span class="status">{{ statusLabel(data.status) }}</span>
              <span class="time">Kita: {{ kitaName(data.kitaId) }}</span>
            </div>
            <h2>{{ data.title }}</h2>
            <p class="info">Erstellt am: {{ data.createdAt | date: 'dd.MM.yyyy' }}</p>
            <p class="info">Standort: {{ locationLabelForKita(data.kitaId) }}</p>
            <p class="info">Adresse: {{ locationAddressForKita(data.kitaId) }}</p>
          </div>
        }
      }
    </div>

    <div class="panel">
      <h3>Beteiligte</h3>
      <app-stakeholder-list [stakeholders]="stakeholders()" />
    </div>

    <div class="panel">
      <h3>Beteiligte hinzufuegen</h3>
      <form class="form" [formGroup]="form" (ngSubmit)="submitStakeholder()">
        <label>
          Beteiligte Person
          <app-stakeholder-select
            [stakeholders]="availableStakeholders()"
            [selectedId]="form.controls.stakeholderId.value"
            [disabled]="stakeholdersStatus() !== 'success'"
            [required]="true"
            (selectedIdChange)="form.controls.stakeholderId.setValue($event ?? '')"
          />
        </label>
        @if (stakeholdersStatus() === 'loading') {
          <div class="state">
            <p class="state-title">Beteiligte werden geladen</p>
          </div>
        }
        @if (stakeholdersStatus() === 'error') {
          <div class="state">
            <p class="state-title">Beteiligte konnten nicht geladen werden</p>
            <p class="state-text">{{ stakeholdersError()?.message ?? 'Unbekannter Fehler' }}</p>
          </div>
        }
        <label>
          Rolle
          <select formControlName="role">
            @for (option of roleOptions; track option.value) {
              <option [value]="option.value">{{ option.label }}</option>
            }
          </select>
        </label>
        <button
          class="primary-button"
          type="submit"
          [disabled]="form.invalid || isLoading() || stakeholdersStatus() !== 'success'"
        >
          Beteiligte hinzufuegen
        </button>
      </form>
    </div>
  </div>

  <nav class="tabs">
    <a routerLink="timeline" routerLinkActive="active">Zeitlinie</a>
    <a routerLink="tasks" routerLinkActive="active">Aufgaben</a>
    <a routerLink="meetings" routerLinkActive="active">Termine</a>
  </nav>

  <section class="tab-panel">
    <router-outlet />
  </section>
</section>
