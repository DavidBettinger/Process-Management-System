<section class="space-y-6">
  <header class="space-y-2">
    <h2 class="text-xl font-semibold text-slate-900">Zeitlinie</h2>
    <p class="text-sm text-slate-600">Graphische Sicht auf Termine, Aufgaben und Beteiligte entlang der Zeitachse.</p>
  </header>

  <app-tw-card [className]="'space-y-4'">
    @if (isLoading()) {
      <div class="space-y-3 animate-pulse">
        <div class="h-4 w-3/4 rounded-full bg-slate-200"></div>
        <div class="h-4 w-2/3 rounded-full bg-slate-200"></div>
      </div>
    }

    @if (status() === 'error') {
      <div class="space-y-2">
        <p class="text-sm font-semibold text-slate-900">Zeitlinien-Graph konnte nicht geladen werden</p>
        <p class="text-sm text-slate-600">{{ error()?.message ?? 'Unbekannter Fehler' }}</p>
        <button appTwButton="ghost" size="sm" type="button" (click)="retry()">Erneut versuchen</button>
      </div>
    }

    @if (isEmpty()) {
      <div class="space-y-2">
        <p class="text-sm font-semibold text-slate-900">Noch keine Eintraege vorhanden</p>
        <p class="text-sm text-slate-600">Termine, Aufgaben und Beteiligte erscheinen hier, sobald Daten vorliegen.</p>
      </div>
    }

    @if (status() === 'success' && !isEmpty()) {
      <div class="grid gap-4 xl:grid-cols-[minmax(0,1fr)_20rem]">
        <app-timeline-graph
          [graphDto]="graphDto()"
          [renderModel]="renderModel()"
          [selectedNodeId]="selectedNodeId()"
          [selectedNodeType]="selectedNodeType()"
          (nodeSelected)="onNodeSelected($event)"
          (selectionCleared)="clearSelection()"
        />

        <aside
          class="h-fit rounded-2xl border border-slate-200 bg-slate-50 p-4"
          data-testid="timeline-details-panel"
        >
          <section class="space-y-3 border-b border-slate-200 pb-4 mb-4" data-testid="timeline-status-legend">
            <h3 class="text-sm font-semibold text-slate-900">Farblegende</h3>

            <div class="space-y-2">
              <p class="text-xs font-medium uppercase tracking-wide text-slate-600">Termine</p>
              <ul class="space-y-1">
                @for (item of meetingLegend; track item.key) {
                  <li class="flex items-center gap-2 text-xs text-slate-700">
                    <span class="h-3 w-3 rounded-sm border" [class]="item.swatchClass"></span>
                    <span>{{ item.label }}</span>
                  </li>
                }
              </ul>
            </div>

            <div class="space-y-2">
              <p class="text-xs font-medium uppercase tracking-wide text-slate-600">Aufgaben</p>
              <ul class="space-y-1">
                @for (item of taskLegend; track item.key) {
                  <li class="flex items-center gap-2 text-xs text-slate-700">
                    <span class="h-3 w-3 rounded-sm border" [class]="item.swatchClass"></span>
                    <span>{{ item.label }}</span>
                  </li>
                }
              </ul>
            </div>
          </section>

          @if (!selectedDetails()) {
            <p class="text-sm text-slate-600">
              Knoten auswaehlen, um Termin-, Aufgaben- oder Beteiligten-Details anzuzeigen.
            </p>
          }

          @if (meetingDetails(); as meeting) {
            <div class="space-y-3" data-testid="timeline-details-meeting">
              <h3 class="text-sm font-semibold text-slate-900">Termin</h3>
              <dl class="space-y-2 text-sm">
                <div>
                  <dt class="font-medium text-slate-700">Titel</dt>
                  <dd class="text-slate-900">{{ meeting.title }}</dd>
                </div>
                <div>
                  <dt class="font-medium text-slate-700">Datum</dt>
                  <dd class="text-slate-900">{{ meeting.dateLabel }}</dd>
                </div>
                <div>
                  <dt class="font-medium text-slate-700">Ort</dt>
                  <dd class="text-slate-900">{{ meeting.locationLabel }}</dd>
                </div>
                <div>
                  <dt class="font-medium text-slate-700">Beteiligte</dt>
                  <dd class="text-slate-900">
                    @if (meeting.participantLabels.length > 0) {
                      <ul class="list-disc space-y-1 pl-5">
                        @for (participant of meeting.participantLabels; track participant) {
                          <li>{{ participant }}</li>
                        }
                      </ul>
                    } @else {
                      <span>Keine Beteiligten hinterlegt</span>
                    }
                  </dd>
                </div>
              </dl>
            </div>
          }

          @if (taskDetails(); as task) {
            <div class="space-y-3" data-testid="timeline-details-task">
              <h3 class="text-sm font-semibold text-slate-900">Aufgabe</h3>
              <dl class="space-y-2 text-sm">
                <div>
                  <dt class="font-medium text-slate-700">Titel</dt>
                  <dd class="text-slate-900">{{ task.title }}</dd>
                </div>
                <div>
                  <dt class="font-medium text-slate-700">Status</dt>
                  <dd class="text-slate-900">{{ task.statusLabel }}</dd>
                </div>
                <div>
                  <dt class="font-medium text-slate-700">Prioritaet</dt>
                  <dd class="text-slate-900">{{ task.priorityLabel }}</dd>
                </div>
                <div>
                  <dt class="font-medium text-slate-700">Zustaendig</dt>
                  <dd class="text-slate-900">{{ task.assigneeLabel }}</dd>
                </div>
              </dl>
            </div>
          }

          @if (stakeholderDetails(); as stakeholder) {
            <div class="space-y-3" data-testid="timeline-details-stakeholder">
              <h3 class="text-sm font-semibold text-slate-900">Beteiligte Person</h3>
              <dl class="space-y-2 text-sm">
                <div>
                  <dt class="font-medium text-slate-700">Name</dt>
                  <dd class="text-slate-900">{{ stakeholder.fullName }}</dd>
                </div>
                <div>
                  <dt class="font-medium text-slate-700">Rolle</dt>
                  <dd class="text-slate-900">{{ stakeholder.roleLabel }}</dd>
                </div>
                <div>
                  <dt class="font-medium text-slate-700">Zugeordneter Termin</dt>
                  <dd class="text-slate-900">{{ stakeholder.relatedMeetingLabel }}</dd>
                </div>
              </dl>
            </div>
          }
        </aside>
      </div>
    }
  </app-tw-card>
</section>
