<section class="space-y-6">
  <header class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
    <div>
      <p class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">Prozess</p>
      <h1 class="mt-2 text-3xl font-semibold text-slate-900">Prozessdetails</h1>
      <p class="mt-2 text-sm text-slate-600">Status, Beteiligte und naechste Schritte im Blick behalten.</p>
    </div>
    <div class="flex flex-col items-start gap-2 sm:items-end">
      <button
        appTwButton="primary"
        size="sm"
        type="button"
        [disabled]="!canActivate() || isLoading()"
        (click)="activateCase()"
      >
        Prozess aktivieren
      </button>
      @if (activationHint()) {
        <p class="max-w-xs text-xs font-medium text-amber-700 sm:text-right">{{ activationHint() }}</p>
      }
    </div>
  </header>

  <div class="grid gap-6 lg:grid-cols-3">
    <app-tw-card [className]="'space-y-4'">
      @if (isLoading()) {
        <div class="space-y-3 animate-pulse">
          <div class="h-4 w-3/4 rounded-full bg-slate-200"></div>
          <div class="h-4 w-2/3 rounded-full bg-slate-200"></div>
        </div>
      }

      @if (status() === 'error') {
        <div class="space-y-2">
          <p class="text-sm font-semibold text-slate-900">Prozess konnte nicht geladen werden</p>
          <p class="text-sm text-slate-600">{{ error()?.message ?? 'Unbekannter Fehler' }}</p>
          <button appTwButton="ghost" size="sm" type="button" (click)="caseStore.loadCase()">
            Erneut versuchen
          </button>
        </div>
      }

      @if (status() === 'success') {
        @if (caseData(); as data) {
          <div class="space-y-3">
            <div class="flex items-center justify-between text-xs text-slate-500">
              <app-tw-badge [variant]="statusVariant(data.status)">{{ statusLabel(data.status) }}</app-tw-badge>
              <span>Kita: {{ kitaName(data.kitaId) }}</span>
            </div>
            <h2 class="text-xl font-semibold text-slate-900">{{ data.title }}</h2>
            <p class="text-sm text-slate-600">Erstellt am: {{ data.createdAt | date: 'dd.MM.yyyy' }}</p>
            <p class="text-sm text-slate-600">Standort: {{ locationLabelForKita(data.kitaId) }}</p>
            <p class="text-sm text-slate-600">Adresse: {{ locationAddressForKita(data.kitaId) }}</p>
          </div>
        }
      }
    </app-tw-card>

    <app-tw-card [className]="'space-y-3'">
      <h3 class="text-lg font-semibold text-slate-900">Beteiligte</h3>
      <app-stakeholder-list [stakeholders]="stakeholders()" />
    </app-tw-card>

    <app-tw-card [className]="'space-y-4'">
      <h3 class="text-lg font-semibold text-slate-900">Beteiligte hinzufuegen</h3>
      <form class="space-y-4" [formGroup]="form" (ngSubmit)="submitStakeholder()">
        <app-tw-field
          label="Beteiligte Person"
          [required]="true"
          [error]="isInvalid('stakeholderId') ? requiredMessage('Beteiligte Person') : null"
        >
          <app-stakeholder-select
            class="w-full"
            [stakeholders]="availableStakeholders()"
            [selectedId]="form.controls.stakeholderId.value"
            [disabled]="stakeholdersStatus() !== 'success'"
            [required]="true"
            (selectedIdChange)="form.controls.stakeholderId.setValue($event ?? '')"
          />
        </app-tw-field>

        @if (stakeholdersStatus() === 'loading') {
          <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-xs font-semibold text-slate-600">
            Beteiligte werden geladen
          </div>
        }
        @if (stakeholdersStatus() === 'error') {
          <div class="rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-xs font-semibold text-rose-700">
            <p>Beteiligte konnten nicht geladen werden</p>
            <p class="mt-1 text-xs font-normal text-rose-600">
              {{ stakeholdersError()?.message ?? 'Unbekannter Fehler' }}
            </p>
          </div>
        }

        <app-tw-field
          label="Rolle"
          forId="case-role"
          [required]="true"
          [error]="isInvalid('role') ? requiredMessage('Rolle') : null"
        >
          <select
            id="case-role"
            formControlName="role"
            class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200"
          >
            @for (option of roleOptions; track option.value) {
              <option [value]="option.value">{{ option.label }}</option>
            }
          </select>
        </app-tw-field>
        <button
          appTwButton="primary"
          size="sm"
          type="submit"
          [disabled]="form.invalid || isLoading() || stakeholdersStatus() !== 'success'"
        >
          Beteiligte hinzufuegen
        </button>
      </form>
    </app-tw-card>
  </div>

  <nav class="flex flex-wrap gap-2 border-b border-slate-200 pb-2">
    <a
      routerLink="timeline"
      routerLinkActive="border-slate-900 text-slate-900"
      class="border-b-2 border-transparent pb-1 text-sm font-semibold text-slate-500 hover:text-slate-900"
    >
      Zeitlinie
    </a>
    <a
      routerLink="tasks"
      routerLinkActive="border-slate-900 text-slate-900"
      class="border-b-2 border-transparent pb-1 text-sm font-semibold text-slate-500 hover:text-slate-900"
    >
      Aufgaben
    </a>
    <a
      routerLink="meetings"
      routerLinkActive="border-slate-900 text-slate-900"
      class="border-b-2 border-transparent pb-1 text-sm font-semibold text-slate-500 hover:text-slate-900"
    >
      Termine
    </a>
  </nav>

  <section class="min-h-[120px]">
    <router-outlet />
  </section>
</section>
