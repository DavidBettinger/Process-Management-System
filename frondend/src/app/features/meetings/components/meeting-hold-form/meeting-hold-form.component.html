<section class="hold-form">
  <header class="hold-header">
    <div>
      <h2>Termin durchfuehren</h2>
      <p>Halte Protokoll fest und lege Aufgabenpunkte an.</p>
    </div>
  </header>

  <div class="result" *ngIf="holdResult">
    <p class="result-title">Termin abgeschlossen</p>
    <p class="result-text">Erstellte Aufgaben: {{ holdResult.createdTaskIds.length }}</p>
    <p class="result-hint">Die Aufgaben findest du in der Aufgabenliste dieses Prozesses.</p>
    <button class="ghost-button" type="button" (click)="clearHoldResult()">Hinweis schliessen</button>
  </div>

  <form class="form" [formGroup]="form" (ngSubmit)="submit()">
    <ng-container *ngIf="meetings.length > 0; else manualId">
      <label>
        Termin
        <select formControlName="meetingId" (change)="applyMeetingDefaults(form.controls.meetingId.value)">
          <option value="">Bitte waehlen</option>
          <option *ngFor="let meeting of meetings" [value]="meeting.id">{{ meetingLabel(meeting) }}</option>
        </select>
      </label>
    </ng-container>
    <ng-template #manualId>
      <label>
        Termin
        <input type="text" formControlName="meetingId" placeholder="Termin eingeben" />
      </label>
      <p class="hint">Kein Termin vorhanden? Bitte zuerst einen Termin planen.</p>
    </ng-template>

    <label>
      Durchgefuehrt am
      <input type="datetime-local" formControlName="heldAt" />
    </label>

    <label>
      Standort
      <select formControlName="locationId">
        <option value="">Bitte waehlen</option>
        <option *ngFor="let location of locations" [value]="location.id">
          {{ location.label }} Â· {{ location.address.city }}
        </option>
      </select>
    </label>
    <p class="hint" *ngIf="locations.length === 0">
      Es sind noch keine Standorte vorhanden. Bitte zuerst einen Standort anlegen.
    </p>
    <a class="link" routerLink="/locations">Neuen Standort anlegen</a>

    <div class="participants">
      <div class="participants-header">
        <p>Teilnehmende</p>
        <button class="ghost-button" type="button" (click)="addParticipant()">Teilnehmende hinzufuegen</button>
      </div>
      <div class="participant-row" *ngFor="let participantId of participantIds; let i = index">
        <app-stakeholder-select
          [stakeholders]="stakeholders"
          [selectedId]="participantId || null"
          [disabled]="!stakeholdersReady"
          [required]="true"
          (selectedIdChange)="updateParticipant(i, $event)"
        />
        <button
          class="ghost-button"
          type="button"
          (click)="removeParticipant(i)"
          [disabled]="participantIds.length === 1"
        >
          Entfernen
        </button>
      </div>
      <p class="error" *ngIf="participantsError">{{ participantsError }}</p>
      <div class="state" *ngIf="!stakeholdersReady && !stakeholdersError">
        <p class="state-title">Beteiligte werden geladen</p>
      </div>
      <div class="state" *ngIf="!stakeholdersReady && stakeholdersError">
        <p class="state-title">Beteiligte konnten nicht geladen werden</p>
        <p class="state-text">{{ stakeholdersError }}</p>
      </div>
    </div>

    <label>
      Protokoll
      <textarea formControlName="minutesText" rows="4" placeholder="Wichtige Ergebnisse und Beschluesse"></textarea>
    </label>

    <app-action-items-editor
      [items]="actionItems"
      [stakeholders]="stakeholders"
      (itemsChange)="updateActionItems($event)"
    />

    <p class="error" *ngIf="actionItemsError">{{ actionItemsError }}</p>

    <button class="primary-button" type="submit" [disabled]="isLoading || !stakeholdersReady">
      Termin abschliessen
    </button>
  </form>
</section>
