<section class="space-y-6">
  <header class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
    <div class="space-y-2">
      <h2 class="text-xl font-semibold text-slate-900">Aufgaben</h2>
      <p class="text-sm text-slate-600">Verwalte Aufgaben fuer diesen Prozess und halte den Fortschritt aktuell.</p>
    </div>
    <button appTwButton="primary" type="button" (click)="openCreateDialog()">Aufgabe erstellen</button>
  </header>

  <app-tw-card [className]="'space-y-6'">
    @if (stakeholdersStatus() === 'loading') {
      <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-xs font-semibold text-slate-600">
        Beteiligte werden geladen
      </div>
    }

    @if (stakeholdersStatus() === 'error') {
      <div class="rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
        <p class="font-semibold text-slate-900">Beteiligte konnten nicht geladen werden</p>
        <p class="mt-1 text-sm">{{ stakeholdersError()?.message ?? 'Unbekannter Fehler' }}</p>
      </div>
    }

    @if (isLoading()) {
      <div class="space-y-3 animate-pulse">
        <div class="h-4 w-3/4 rounded-full bg-slate-200"></div>
        <div class="h-4 w-2/3 rounded-full bg-slate-200"></div>
      </div>
    }

    @if (status() === 'error') {
      <div class="rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700 space-y-2">
        <p class="font-semibold text-slate-900">Aufgaben konnten nicht geladen werden</p>
        <p class="text-sm">{{ error()?.message ?? 'Unbekannter Fehler' }}</p>
        <button appTwButton="ghost" size="sm" type="button" (click)="tasksStore.loadTasks()">
          Erneut versuchen
        </button>
      </div>
    }

    @if (status() === 'success' && tasks().length === 0) {
      <div class="rounded-xl border border-dashed border-slate-200 px-4 py-3 text-sm text-slate-600">
        <p class="font-semibold text-slate-900">Keine Aufgaben vorhanden</p>
        <p class="mt-1">Erstelle Aufgaben in Terminen oder fuege sie spaeter hinzu.</p>
      </div>
    }

    @if (status() === 'success' && tasks().length > 0) {
      <app-task-list
        [tasks]="tasks()"
        [busyTaskIds]="busyTaskIds()"
        [stakeholders]="stakeholders()"
        [stakeholdersReady]="stakeholdersStatus() === 'success'"
        (assign)="handleAssign($event)"
        (start)="handleStart($event)"
        (block)="handleBlock($event)"
        (unblock)="handleUnblock($event)"
        (decline)="handleDecline($event)"
        (resolve)="handleResolve($event)"
      />
    }
  </app-tw-card>
</section>

<ng-template #createTaskDialog>
  <app-task-create-form
    [showHeader]="false"
    [submitLabel]="'Erstellen'"
    [showCancel]="true"
    [cancelLabel]="'Abbrechen'"
    [loading]="isLoading()"
    (cancel)="handleCreateCancel()"
    (create)="handleCreateFromOverlay($event)"
  />
</ng-template>
