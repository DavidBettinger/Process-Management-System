<!--suppress HtmlUnknownAttribute -->
<div
  class="overflow-x-auto rounded-2xl border border-slate-200 bg-slate-50 p-4 touch-none"
  [class.cursor-grab]="layout().hasContent && !isDragging()"
  [class.cursor-grabbing]="layout().hasContent && isDragging()"
  [class.select-none]="isDragging()"
>
  @if (layout().hasContent) {
    <svg
      [attr.width]="layout().width"
      [attr.height]="layout().height"
      [attr.viewBox]="'0 0 ' + layout().width + ' ' + layout().height"
      class="block"
      role="img"
      aria-label="Zeitlinien-Graph"
      data-testid="timeline-graph-svg"
      (pointerdown)="onPointerDown($event)"
      (pointermove)="onPointerMove($event)"
      (pointerup)="onPointerUp($event)"
      (pointerleave)="onPointerUp($event)"
      (pointercancel)="onPointerCancel($event)"
      (wheel)="onWheel($event)"
      (click)="onBackgroundClick()"
    >
      <g [attr.transform]="panTransform()" data-testid="timeline-pan-layer">
        <line
          [attr.x1]="layout().axisStartX"
          [attr.y1]="layout().axisY"
          [attr.x2]="layout().axisEndX"
          [attr.y2]="layout().axisY"
          stroke="#94a3b8"
          stroke-width="2"
        />

        <line
          [attr.x1]="layout().nowX"
          [attr.y1]="52"
          [attr.x2]="layout().nowX"
          [attr.y2]="420"
          stroke="#f97316"
          stroke-width="2"
          stroke-dasharray="5 5"
          data-testid="today-marker-line"
        />
        <text
          [attr.x]="layout().nowX + 8"
          y="42"
          fill="#c2410c"
          class="text-xs font-semibold"
          data-testid="today-marker-label"
        >
          Heute
        </text>

        @if (layout().unlinkedBucketX !== null) {
          <text
            [attr.x]="layout().unlinkedBucketX"
            y="58"
            text-anchor="middle"
            fill="#475569"
            class="text-xs font-semibold"
          >
            Ohne Termin
          </text>
        }

        @for (edge of layout().edges; track edge.id) {
          <path
            [attr.d]="edge.path"
            fill="none"
            [attr.data-testid]="'timeline-edge-' + edge.id"
            [attr.stroke]="edgeStroke(edge)"
            [attr.stroke-width]="edgeStrokeWidth(edge)"
            [attr.stroke-dasharray]="edge.type === 'participation' ? '4 4' : null"
            [attr.opacity]="edgeOpacity(edge)"
          />
        }

        @for (task of layout().tasks; track task.id) {
          <g
            [attr.transform]="'translate(' + task.x + ',' + task.y + ')'"
            class="cursor-pointer"
            [attr.data-testid]="'timeline-node-task-' + task.id"
            (click)="onTaskClick(task.id, $event)"
          >
            <rect
              width="220"
              height="74"
              rx="14"
              [attr.class]="taskCardClasses(task)"
              [attr.stroke-width]="isTaskSelected(task.id) ? 2.5 : 1.3"
            />
            <text x="12" y="25" [attr.class]="'text-xs font-semibold ' + taskTitleClasses(task)">
              {{ truncate(task.title, 33) }}
            </text>
            <text x="12" y="48" [attr.class]="'text-[11px] ' + taskStatusClasses(task)">
              {{ task.statusLabel }}
            </text>
            @if (task.isOverdue) {
              <g transform="translate(12,54)" [attr.data-testid]="'timeline-task-overdue-' + task.id">
                <rect width="78" height="16" rx="8" class="fill-rose-200 stroke-rose-400" />
                <text x="39" y="11" text-anchor="middle" class="text-[9px] font-semibold fill-rose-900">
                  Ueberfaellig
                </text>
              </g>
            }
            <g transform="translate(170,11)">
              <rect width="38" height="20" rx="10" [attr.class]="taskPriorityBadgeClasses(task)" />
              <text
                x="19"
                y="14"
                text-anchor="middle"
                [attr.class]="'text-[10px] font-semibold ' + taskPriorityLabelClasses(task)"
              >
                {{ task.priorityLabel }}
              </text>
            </g>
          </g>
        }

        @for (stakeholder of layout().stakeholders; track stakeholder.id) {
          <g
            [attr.transform]="'translate(' + stakeholder.x + ',' + stakeholder.y + ')'"
            class="cursor-pointer"
            [attr.data-testid]="'timeline-node-stakeholder-' + stakeholder.id"
            (click)="onStakeholderClick(stakeholder.id, $event)"
          >
            <rect
              width="210"
              height="46"
              rx="12"
              fill="#ffffff"
              [attr.stroke]="stakeholderStroke(stakeholder.id)"
              [attr.stroke-width]="stakeholderStrokeWidth(stakeholder.id)"
            />
            <text x="12" y="28" fill="#1e3a8a" class="text-xs font-medium">
              {{ truncate(stakeholder.label, 34) }}
            </text>
          </g>
        }

        @for (meeting of layout().meetings; track meeting.id) {
          <g
            [attr.transform]="'translate(' + meeting.x + ',' + meeting.y + ')'"
            class="cursor-pointer"
            [attr.data-testid]="'timeline-node-meeting-' + meeting.id"
            (click)="onMeetingClick(meeting.id, $event)"
          >
            <circle cx="0" cy="0" r="11" [attr.class]="meetingCircleClasses(meeting)" />
            <rect
              x="-110"
              y="18"
              width="220"
              height="38"
              rx="10"
              [attr.class]="meetingCardClasses(meeting)"
              [attr.stroke-width]="meetingStrokeWidth(meeting.id)"
            />
            <text
              x="0"
              y="42"
              text-anchor="middle"
              [attr.class]="'text-[11px] font-semibold ' + meetingLabelClasses(meeting)"
            >
              {{ truncate(meeting.label, 34) }}
            </text>
          </g>
        }
      </g>
    </svg>
  } @else {
    <div class="rounded-xl border border-slate-200 bg-white px-4 py-6 text-sm font-medium text-slate-600">
      Keine Daten fuer den Zeitlinien-Graphen vorhanden.
    </div>
  }
</div>
